<view class="goods-detail-page">
  <view class="goods-head">
    <swiper
      wx:if="{{details.images.length > 1}}"
      class="goods-swiper"
      indicator-dots="{{true}}"
      autoplay="{{autoplay}}"
      interval="{{interval}}"
      duration="{{duration}}"
      indicator-color="rgba(255, 255, 255, 0.5)"
      indicator-active-color="#2C3E50"
    >
      <swiper-item wx:for="{{details.images}}" wx:key="index">
        <image
          class="swipe-img"
          src="{{item}}"
          mode="aspectFill"
          bindtap="previewImage"
          data-current="{{index}}"
        />
      </swiper-item>
    </swiper>

    <!-- å•å¼ å›¾ç‰‡æ˜¾ç¤º -->
    <image
      wx:elif="{{details.images.length === 1}}"
      class="swipe-img"
      src="{{details.images[0]}}"
      mode="aspectFill"
      bindtap="previewImage"
      data-current="0"
    />

    <!-- å¤‡ç”¨å›¾ç‰‡ -->
    <image
      wx:else
      class="swipe-img"
      src="{{details.primaryImage || '/assets/placeholder.png'}}"
      mode="aspectFill"
    />
    <view class="goods-info">
      <!-- B2Bå•†å“æ ‡é¢˜åŒºåŸŸ -->
      <view class="goods-title">
        <view class="goods-name">{{details.title}}</view>
      </view>

      <!-- B2Bæ ¸å¿ƒä¿¡æ¯å±•ç¤º -->
      <view class="b2b-info-cards">
        <view class="b2b-info-card">
          <view class="b2b-icon">ğŸ­</view>
          <view class="b2b-info">
            <text class="b2b-label">æœ€å°èµ·è®¢é‡</text>
            <text class="b2b-value">{{details.minOrderQuantity}} {{details.unit}}</text>
          </view>
        </view>

        <view class="b2b-info-card">
          <view class="b2b-icon">â±ï¸</view>
          <view class="b2b-info">
            <text class="b2b-label">äº¤è´§å‘¨æœŸ</text>
            <text class="b2b-value">{{details.leadTime}} å¤©</text>
          </view>
        </view>

        <view class="b2b-info-card">
          <view class="b2b-icon">â­</view>
          <view class="b2b-info">
            <text class="b2b-label">å“è´¨ç­‰çº§</text>
            <text class="b2b-value">Açº§ä¼˜å“</text>
          </view>
        </view>
      </view>

      <!-- è§„æ ¼å‚æ•°éƒ¨åˆ† -->
      <view class="specifications-section">
        <view class="specifications-title">
          <span class="specifications-title--text">è§„æ ¼å‚æ•°</span>
          <t-image t-class="img" src="{{recRightImg}}" />
        </view>

        <view wx:if="{{details.specificationParams && details.specificationParams.length > 0}}" class="specifications-grid">
          <view class="spec-item" wx:for="{{details.specificationParams}}" wx:key="key">
            <view class="spec-label">{{item.name}}</view>
            <view class="spec-value">{{item.value}}</view>
          </view>
        </view>

        <view wx:else class="no-specifications">
          <text>æš‚æ— è§„æ ¼å‚æ•°ä¿¡æ¯</text>
        </view>
      </view>

    </view>

    <!-- å•†å“è¯„è®ºåŒºåŸŸ -->
    <view class="comments-section">
      <view class="comments-header">
        <view class="comments-title">
          <text class="title-text">å•†å“è¯„ä»·</text>
          <text class="comments-count">({{commentStats.count || 0}})</text>
        </view>
        <view class="comments-rating" wx:if="{{commentStats.avgRating > 0}}">
          <text class="rating-number">{{commentStats.avgRating}}</text>
          <text class="rating-stars">{{ratingStars}}</text>
        </view>
      </view>

      <!-- è¯„è®ºåˆ—è¡¨ -->
      <view class="comments-list" wx:if="{{comments.length > 0}}">
        <view class="comment-item" wx:for="{{comments}}" wx:key="id">
          <view class="comment-header">
            <image class="user-avatar" src="{{item.userAvatar || '/assets/default-avatar.png'}}" />
            <view class="user-info">
              <view class="user-name">{{item.userName || 'åŒ¿åç”¨æˆ·'}}</view>
              <view class="comment-time">{{item.createdAt}}</view>
            </view>
            <view class="comment-rating">
              <text class="stars">{{item.ratingStars}}</text>
            </view>
          </view>
          <view class="comment-content">{{item.content}}</view>

          <!-- å•†å®¶å›å¤ -->
          <view class="admin-reply" wx:if="{{item.adminReply}}">
            <view class="reply-label">å•†å®¶å›å¤ï¼š</view>
            <view class="reply-content">{{item.adminReply}}</view>
            <view class="reply-time">{{item.replyTime}}</view>
          </view>

          <!-- åˆ é™¤æŒ‰é’®ï¼ˆåªæœ‰è‡ªå·±çš„è¯„è®ºæ‰æ˜¾ç¤ºï¼‰ -->
          <view class="comment-actions" wx:if="{{userInfo && item.userId === userInfo.id}}">
            <button class="delete-btn" bindtap="deleteComment" data-id="{{item.id}}">åˆ é™¤</button>
          </view>
        </view>
      </view>

      <!-- æ— è¯„è®ºæç¤º -->
      <view class="no-comments" wx:else>
        <text class="no-comments-icon">ğŸ’¬</text>
        <text class="no-comments-text">æš‚æ— è¯„ä»·ï¼Œå¿«æ¥å‘è¡¨æ‚¨çš„çœ‹æ³•å§~</text>
      </view>

      <!-- åŠ è½½æ›´å¤š / æ”¶èµ·æŒ‰é’® -->
      <view class="load-more-section" wx:if="{{comments.length > 0}}">
        <!-- åŠ è½½æ›´å¤šæŒ‰é’® -->
        <button class="load-more-btn" wx:if="{{hasMoreComments}}" bindtap="loadMoreComments">
          <text class="btn-text">åŠ è½½æ›´å¤šè¯„ä»·</text>
          <text class="btn-icon">â–¼</text>
        </button>

        <!-- æ”¶èµ·æŒ‰é’®ï¼ˆæ˜¾ç¤ºè¶…è¿‡5æ¡æ—¶ï¼‰ -->
        <button class="collapse-btn" wx:if="{{comments.length > 5}}" bindtap="collapseComments">
          <text class="btn-text">æ”¶èµ·è¯„ä»·</text>
          <text class="btn-icon">â–²</text>
        </button>

        <!-- æ²¡æœ‰æ›´å¤šè¯„è®ºæç¤º -->
        <view class="no-more-text-wrapper" wx:if="{{!hasMoreComments && comments.length <= 5}}">
          <text class="no-more-text">å·²åŠ è½½å…¨éƒ¨è¯„ä»·</text>
        </view>
      </view>

      <!-- å†™è¯„è®ºæŒ‰é’® -->
      <view class="write-comment-section">
        <button class="write-comment-btn" bindtap="showCommentDialog">
          <text class="btn-icon">âœï¸</text>
          <text class="btn-text">å†™è¯„ä»·</text>
        </button>
      </view>
    </view>

    <!-- B2Bä¼ä¸šè”ç³»ä¿¡æ¯ -->
    <view class="b2b-contact-section">
      <view class="contact-title">ä¼ä¸šé‡‡è´­è”ç³»</view>
      <view class="contact-info">
        <view class="contact-item" bindtap="makePhoneCall">
          <view class="contact-icon">ğŸ“</view>
          <view class="contact-details">
            <view class="contact-label">é‡‡è´­çƒ­çº¿</view>
            <view class="contact-value">157-3628-8761</view>
          </view>
          <view class="contact-action">æ‹¨æ‰“</view>
        </view>

        <view class="contact-item">
          <view class="contact-icon">ğŸ“§</view>
          <view class="contact-details">
            <view class="contact-label">å•†åŠ¡é‚®ç®±</view>
            <view class="contact-value">sales@sj-tex.com</view>
          </view>
          <view class="contact-action" bindtap="copyEmail">å¤åˆ¶</view>
        </view>

        <view class="contact-item">
          <view class="contact-icon">ğŸŒ</view>
          <view class="contact-details">
            <view class="contact-label">å®˜æ–¹ç½‘ç«™</view>
            <view class="contact-value">www.sj-tex.com</view>
          </view>
          <view class="contact-action" bindtap="openWebsite">è®¿é—®</view>
        </view>

        <!-- é€€å‡ºç™»å½•æŒ‰é’® -->
        <view class="contact-item logout-item" wx:if="{{userInfo}}" bindtap="logout">
          <view class="contact-icon">ğŸšª</view>
          <view class="contact-details">
            <view class="contact-label">ç”¨æˆ·ç®¡ç†</view>
            <view class="contact-value">{{userInfo.nickname || 'å¾®ä¿¡ç”¨æˆ·'}}</view>
          </view>
          <view class="contact-action logout-action">é€€å‡ºç™»å½•</view>
        </view>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨æ“ä½œæ  -->
  <view class="b2b-bottom-bar">
    <view class="b2b-action-buttons">
      <!-- æ”¶è—æŒ‰é’® - å¦‚æœæœªç™»å½•ï¼Œæ˜¾ç¤ºç™»å½•æŒ‰é’® -->
      <block wx:if="{{!userInfo}}">
        <button class="b2b-btn favorite" bindtap="onGetUserInfoForFavorite">
          <text class="btn-icon">â­</text>
          <text class="btn-text">ç™»å½•æ”¶è—</text>
        </button>
      </block>
      <block wx:else>
        <button class="b2b-btn favorite {{isFavorited ? 'favorited' : ''}}" bindtap="toAddFavorite">
          <text class="btn-icon">{{isFavorited ? 'â¤ï¸' : 'â­'}}</text>
          <text class="btn-text">{{isFavorited ? 'å·²æ”¶è—' : 'æ”¶è—å•†å“'}}</text>
        </button>
      </block>

      <button class="b2b-btn inquiry" bindtap="toInquiry">
        <text class="btn-icon">ğŸ“</text>
        <text class="btn-text">ç«‹å³è¯¢ä»·</text>
      </button>
    </view>
  </view>

  <!-- è¯„è®ºå¼¹çª— -->
  <view class="comment-dialog {{showDialog ? 'show' : ''}}" catchtouchmove="preventMove">
    <view class="dialog-mask" bindtap="hideCommentDialog"></view>
    <view class="dialog-content">
      <view class="dialog-header">
        <text class="dialog-title">å†™è¯„ä»·</text>
        <text class="dialog-close" bindtap="hideCommentDialog">âœ•</text>
      </view>

      <!-- è¯„åˆ† -->
      <view class="dialog-rating">
        <text class="rating-label">è¯„åˆ†ï¼š</text>
        <view class="rating-stars-input">
          <text class="star {{index < rating ? 'active' : ''}}"
                wx:for="{{5}}"
                wx:key="index"
                bindtap="setRating"
                data-rating="{{index + 1}}">â˜…</text>
        </view>
      </view>

      <!-- è¯„è®ºå†…å®¹ -->
      <view class="dialog-textarea">
        <textarea
          class="comment-input"
          placeholder="åˆ†äº«æ‚¨çš„ä½¿ç”¨ä½“éªŒ..."
          maxlength="500"
          value="{{commentContent}}"
          bindinput="onCommentInput"
          auto-height
        />
        <text class="input-counter">{{commentContent.length}}/500</text>
      </view>

      <!-- æäº¤æŒ‰é’® -->
      <view class="dialog-actions">
        <button class="dialog-btn cancel" bindtap="hideCommentDialog">å–æ¶ˆ</button>
        <button class="dialog-btn submit" bindtap="submitComment">æäº¤è¯„ä»·</button>
      </view>
    </view>
  </view>
</view>
<t-toast id="t-toast" />